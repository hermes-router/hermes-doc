

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Monitoring &mdash; Hermes 0.1a documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dashboard Gallery" href="dashboards.html" />
    <link rel="prev" title="Usage" href="usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/hermes_logo_w.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/hermes-router/hermes">github.com/hermes-router/hermes</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">What is Hermes?</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Monitoring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#log-files">Log files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#graphite">Graphite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bookkeeer-with-redash">Bookkeeer with Redash</a></li>
<li class="toctree-l2"><a class="reference internal" href="#alerts">Alerts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dashboards.html">Dashboard Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Topics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Code Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Hermes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Monitoring</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="monitoring">
<h1>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h1>
<p>Hermes provides three different mechanisms for monitoring the router activity and health.</p>
<div class="section" id="log-files">
<h2>Log files<a class="headerlink" href="#log-files" title="Permalink to this headline">¶</a></h2>
<p>All Hermes services write detailed logging information with timestamps into system log files. The most convenient way to review these logs is to use the “Logs” page of the Hermes web interface. Here you can see a separate tab for every service. The logs are updated whenever you switch between tabs and when you click the refresh button on the top-right.</p>
<p>Using the From/To controls, you can limit the time span that is shown in the log viewer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only the last 1000 lines of each log are displayed to keep the user interface responsive. If you are looking for an older event, use the From/To fields to narrow down the time span.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The log files can also be viewed in the terminal using the journalctl command by providing the service name as argument. For example, “journalctl -u hermes_ui.service” shows the log of the webgui. You can see the names of the different services as tooltip when hovering over the tabs on the “Logs” page.</p>
</div>
</div>
<div class="section" id="graphite">
<h2>Graphite<a class="headerlink" href="#graphite" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://graphiteapp.org/">Graphite</a> is a very powerful tool for monitoring the health of a server. It can collect time-series data from various sources and stores the data in a database. Instead of displaying the data directly with Graphite, the collected data is often visualized using <a class="reference external" href="https://grafana.com/">Grafana</a>, which makes it very easy to create dashboards for various data sources and to setup alerts.</p>
<p>We highly recommend that you monitor your Hermes server with Graphite and Grafana. In a typical setup, Graphite and Grafana are running on a separate monitoring server. Basic health parameters like the available disk space, CPU load, and memory usage can be collected by installing the <a class="reference external" href="https://collectd.org/">collectd</a> service on your server, which will transmit the information to your Graphite instance.</p>
<p>Hermes can transmit additional information about its activities to Graphite. To enable it, shutdown all Hermes services and edit the keys graphite_ip and graphite_port in the file hermes.json (here you need to enter the IP and port of your Graphite instance). Afterwards, restart the Hermes services.</p>
<p>Hermes transmits the following information to Graphite:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>hermes.router.main.incoming.series</p></td>
<td><p>Number series in the incoming folder waiting for completion</p></td>
</tr>
<tr class="row-odd"><td><p>hermes.router.main.incoming.files</p></td>
<td><p>Number of received DICOM files waiting in the incoming folder</p></td>
</tr>
<tr class="row-even"><td><p>hermes.router.main.events.run</p></td>
<td><p>Triggered when the router checks for incoming files (value=1)</p></td>
</tr>
<tr class="row-odd"><td><p>hermes.router.main.events.boot</p></td>
<td><p>Triggered when the router is started (value=1)</p></td>
</tr>
<tr class="row-even"><td><p>hermes.router.main.events.shutdown</p></td>
<td><p>Triggered when the router shuts down (value=1)</p></td>
</tr>
<tr class="row-odd"><td><p>hermes.dispatcher.main.events.run</p></td>
<td><p>Triggered when the dispatcher checks for outgoing series (value=1)</p></td>
</tr>
<tr class="row-even"><td><p>hermes.dispatcher.main.events.boot</p></td>
<td><p>Triggered when the dispatcher is started (value=1)</p></td>
</tr>
<tr class="row-odd"><td><p>hermes.dispatcher.main.events.shutdown</p></td>
<td><p>Triggered when the dispatcher shuts down (value=1)</p></td>
</tr>
<tr class="row-even"><td><p>hermes.cleaner.main.events.run</p></td>
<td><p>Triggered when the cleaner checks for files to-be-deleted (value=1)</p></td>
</tr>
<tr class="row-odd"><td><p>hermes.cleaner.main.events.boot</p></td>
<td><p>Triggered when the cleaner is started (value=1)</p></td>
</tr>
<tr class="row-even"><td><p>hermes.cleaner.main.events.shutdown</p></td>
<td><p>Triggered when the cleaner shuts down (value=1)</p></td>
</tr>
</tbody>
</table>
<p>By creating a visualization of the hermes.x.main.events.run events, you can monitor that all processes are active and responsive.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you have an advanced installation with multiple instances of the router, dispatcher, or cleaner services, it is necessary to name the individual instances (e.g., instance1 &amp; instance2 instead of main). This can be done by providing a name as command-line argument when starting the services (thus, this needs to be configured in the systemd startup scripts).</p>
</div>
<p>The most convenient way for installing Graphite and Grafana is using <a class="reference external" href="https://docs.docker.com/compose/">Docker Compose</a>. Below, you can see a template for docker-compose.yml file for installing both tools. Note that you need to replace the values […] with your own information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
<span class="n">grafana</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">grafana</span><span class="o">/</span><span class="n">grafana</span>
    <span class="n">container_name</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;3000:3000&quot;</span>
    <span class="n">networks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">grafana</span><span class="o">-</span><span class="n">net</span>
    <span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">grafana</span><span class="o">-</span><span class="n">storage</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">grafana</span>
    <span class="n">environment</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">GF_INSTALL_PLUGINS</span><span class="o">=</span><span class="p">[</span><span class="n">add</span> <span class="n">plugins</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span><span class="p">]</span>

<span class="n">graphite</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">graphiteapp</span><span class="o">/</span><span class="n">graphite</span><span class="o">-</span><span class="n">statsd</span>
    <span class="n">container_name</span><span class="p">:</span> <span class="n">graphite</span>
    <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;2003-2004:2003-2004&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;2023-2024:2023-2024&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;8125:8125/udp&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;8126:8126&quot;</span>
    <span class="n">networks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">grafana</span><span class="o">-</span><span class="n">net</span>
    <span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="p">[</span><span class="n">install</span> <span class="n">path</span><span class="p">]</span><span class="o">/</span><span class="n">configs</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">graphite</span><span class="o">/</span><span class="n">conf</span>
    <span class="o">-</span> <span class="o">/</span><span class="p">[</span><span class="n">install</span> <span class="n">path</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">graphite</span><span class="o">/</span><span class="n">storage</span>
    <span class="o">-</span> <span class="o">/</span><span class="p">[</span><span class="n">install</span> <span class="n">path</span><span class="p">]</span><span class="o">/</span><span class="n">statsd_config</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">statsd</span><span class="o">/</span><span class="n">config</span>

<span class="n">networks</span><span class="p">:</span>
<span class="n">grafana</span><span class="o">-</span><span class="n">net</span><span class="p">:</span>

<span class="n">volumes</span><span class="p">:</span>
<span class="n">grafana</span><span class="o">-</span><span class="n">storage</span><span class="p">:</span>
    <span class="n">external</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="bookkeeer-with-redash">
<h2>Bookkeeer with Redash<a class="headerlink" href="#bookkeeer-with-redash" title="Permalink to this headline">¶</a></h2>
<p>All Hermes components transfer real-time information about their activities to Hermes’ bookkeeper service, which acts as central monitoring hub. The bookkeeper service can be disabled if not needed, but it’s highly recommended to use it, as it allows analyzing which series have been processed (or discarded) and what the processing times were. Of course, it also keeps track of all errors and processing abnormalities that might occur. Moreover, because bookkeeper tracks all DICOM files that pass through the router, including series that are discarded, the bookkeeper can be used for data mining that exceeds the capabilities of many PACS systems (e.g., searching for series where a certain contrast agent has been administered).</p>
<p>Bookkeeper is running as RESTful service on a TCP/IP port (by default 8080) and stores the received information in a PostgreSQL database, which can be queried for analytics purpose.</p>
<p>The following information is stored in the database:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Table</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>hermes_events</p></td>
<td><p>General events of Hermes modules, e.g. startup or detected errors</p></td>
</tr>
<tr class="row-odd"><td><p>webgui_events</p></td>
<td><p>Activities of webgui, e.g. login attempts or configuration changes</p></td>
</tr>
<tr class="row-even"><td><p>dicom_files</p></td>
<td><p>All received DICOM files with file name, file UID, and series UID</p></td>
</tr>
<tr class="row-odd"><td><p>dicom_series</p></td>
<td><p>Information on all received series, incl relevant tag information</p></td>
</tr>
<tr class="row-even"><td><p>series_events</p></td>
<td><p>All processing events related to one series, e.g. dispatch or discard</p></td>
</tr>
<tr class="row-odd"><td><p>file_events</p></td>
<td><p>Currently unused</p></td>
</tr>
<tr class="row-even"><td><p>dicom_series_map</p></td>
<td><p>Currently unused</p></td>
</tr>
</tbody>
</table>
<p>The tables dicom_series, series_events, and dicom_files can be joined using series_uid as common column, allowing to query the events associated with one series and the names of the individual DICOM files.</p>
<p>A very convenient and powerful tool for working with the collected PostgreSQL data is the <a class="reference external" href="http://redash.io">Redash</a> web application, which has already been described in the installation section. Redash allows prototyping SQL queries right in the browser and provides a navigator for the database keys. The query results can be displayed as tables or graphically using various visualization options. The visualizations can then be embedded into dashboards, allowing to rapidly create custom dashboards for various applications without need for any programming besides formulating the SQL queries. The dashboards can even be made interactive using a set of available user controls that can be integrated into the SQL queries. Redash is equipped with a multi-user authorization system and can be used simultaneously by different users.</p>
<p>Dashboards that we created for our own Hermes installation include:</p>
<ul class="simple">
<li><p>A dashboard to display all Hermes events in chronological order, with separate display of ERROR events and separate display of the web activity (“System Status”)</p></li>
<li><p>A “Dispatch Browser” that allows reviewing which patient exams have been dispatched to a certain target within a selectable time span</p></li>
<li><p>A “Patient Browser” that allows searching by patient name, sequence, MRN, or ACC and shows all matching images series</p></li>
<li><p>A “Series Detail” dashboard that is cross-linked from the other dashboards and shows all collected information for a selected series, including all DICOM tags and processing events</p></li>
</ul>
<p>Instructions how to create these dashboards are provided in the <a class="reference internal" href="dashboards.html"><span class="doc">Dashboard Gallery</span></a>.</p>
</div>
<div class="section" id="alerts">
<h2>Alerts<a class="headerlink" href="#alerts" title="Permalink to this headline">¶</a></h2>
<p>It is highly recommended to setup alerts for processing errors and server problems, so that you are automatically notified if the Hermes router needs your attention. Both Grafana and Redash provide functions for automatic alerts that can be utilized. With both tools, alerts can be delivered via email. However, we recommend using a messaging tool that supports custom webhooks, such as <a class="reference external" href="https://slack.com">Slack</a>. In this way, alerts can be delivered in real-time and across multiple devices, including smartphones.</p>
<p>Examples for useful alerts include:</p>
<ul class="simple">
<li><p>If the disk space on the server drops below a certain threshold [alert via Grafana]</p></li>
<li><p>If the server cannot be reached (“pinged”) over the network [alert via Grafana]</p></li>
<li><p>If the Hermes services (router, dispatcher, cleaner) have not notified Graphite for a longer period [alert via Grafana]</p></li>
<li><p>If bookkeeper has received any error notifications [alert via Redash]</p></li>
<li><p>If the number of series dispatched to a certain target falls below the expected value [alert via Redash]</p></li>
</ul>
<p>In addition to the alerting options provided by Grafana and Redash, it is also possible setup custom notifications via a small Python script that is periodically executed and that calls the webhooks of your messaging service.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you develop your own alert scripts, make sure to NEVER post any sensitive patient information (PHI) to the messaging service</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dashboards.html" class="btn btn-neutral float-right" title="Dashboard Gallery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kai Tobias Block, Joshy Cyriac

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-63470225-6', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>